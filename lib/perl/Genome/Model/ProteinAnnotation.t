#!/usr/bin/env genome-perl

BEGIN { 
    $ENV{UR_DBI_NO_COMMIT} = 1;
    $ENV{UR_USE_DUMMY_AUTOGENERATED_IDS} = 1;
}

use strict;
use warnings;

use above "Genome";
use Test::More;

use_ok('Genome::Model::ProteinAnnotation') or die;

my $test_data_dir = Genome::Config::get('test_inputs') . '';
my $fasta_file = join('/', $test_data_dir, 'Genome-Model-Tools-Predictor/medium.fasta');
ok(-e $fasta_file, "test fasta file exists at $fasta_file");

my $temp_output_dir = File::Temp::tempdir('Genome-Model-Protein-Annotation-XXXXX', TMPDIR => 1, CLEANUP => 1);
ok(-d $temp_output_dir, "test output directory exists at $temp_output_dir");
ok(-d $temp_output_dir, "create temp output directory at $temp_output_dir");

my $taxon = Genome::Taxon->create(
    name => 'test taxon',
    gram_stain_category => 'positive',
);
ok($taxon, 'created test taxon');

my $pp = Genome::ProcessingProfile::ProteinAnnotation->create(
    name => 'protein annotation test profile',
    strategy => 'psortb',
    chunk_size => 10,
    dump_predictions_to_file => 1,
    dump_predictions_to_biosql => 1,
);
ok($pp, 'created test processing profile for protein annotation');

my $model = Genome::Model::ProteinAnnotation->create(
    subject => $taxon,
    processing_profile => $pp,
    name => 'test model',
    input_fasta_file => $fasta_file,
); 
ok($model, 'created test model for protein annotation');

my $build = Genome::Model::Build->__define__(
    data_directory => $temp_output_dir,
    model => $model,
);
ok($build, 'created test build for protein annotation');
ok($build->data_directory, 'build has a data directory');

my $workflow = $model->_resolve_workflow_for_build($build, 'inline');
ok($workflow, 'generated workflow for protein annotation build');

$workflow->validate();



$pp = Genome::ProcessingProfile::ProteinAnnotation->create(
    name => 'protein annotation Ber test profile',
    strategy => 'Ber',
    chunk_size => 10,
    dump_predictions_to_file => 1,
    dump_predictions_to_biosql => 1,
);
ok($pp, 'created test processing profile for protein annotation');

$model = Genome::Model::ProteinAnnotation->create(
    subject => $taxon,
    processing_profile => $pp,
    name => 'Ber test model',
    input_fasta_file => $fasta_file,
); 
ok($model, 'created test model for protein annotation');

$build = Genome::Model::Build->__define__(
    data_directory => $temp_output_dir,
    model => $model,
);
ok($build, 'created test build for protein annotation');
ok($build->data_directory, 'build has a data directory');

$workflow = $model->_resolve_workflow_for_build($build, 'inline');
ok($workflow, 'generated workflow for protein annotation build');

$workflow->validate();


done_testing();
