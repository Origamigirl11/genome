#!/usr/bin/env genome-perl

use strict;
use warnings;

use File::Path;
use File::Temp;
use Test::More tests => 5;
use File::Compare;
use above 'Genome';

use Genome::Test::Factory::Model::ReferenceAlignment;
use Genome::Test::Factory::Model::SomaticValidation;
use Genome::Test::Factory::Build;

$ENV{UR_DBI_NO_COMMIT} = 1;
$ENV{UR_USE_DUMMY_AUTOGENERATED_IDS} = 1;

BEGIN {
use_ok('Genome::Model::Tools::Analysis::Coverage::CoverageHist');
}

my $archos = `uname -a`;
if ($archos !~ /64/) {
    plan skip_all => "Must run from 64-bit machine";
}


my $test_data =  Genome::Config::get('test_inputs') . "/Genome-Model-Tools-Analysis-Coverage-CoverageHist";

my $tmpbase = File::Temp::tempdir('CoverageHistXXXXX', CLEANUP => 1, TMPDIR => 1);
my $output_file = "$tmpbase/output.pdf";

my $somval_model = Genome::Test::Factory::Model::SomaticValidation->setup_object();
my $somval_model_id = $somval_model->id;
my $somval_build = Genome::Test::Factory::Build->setup_object(
    model_id => $somval_model_id,
    status => 'Succeeded',
    data_directory => join('/', $test_data, 'somval_build_dir'),
);

my $refalign_model = Genome::Test::Factory::Model::ReferenceAlignment->setup_object();
my $refalign_model_id = $refalign_model->id;
my $refalign_build = Genome::Test::Factory::Build->setup_object(
    model_id => $refalign_model_id,
    status => 'Succeeded',
    data_directory => join('/', $test_data, 'refalign_build_dir'),
);

my $cmd = Genome::Model::Tools::Analysis::Coverage::CoverageHist->create(
                    refalign_model_id => $refalign_model_id,
                    output_pdf => $output_file);

ok($cmd, 'command created');
my $rv = $cmd->execute;
is($rv, 1, 'Testing for successful execution.  Expecting 1.  Got: '.$rv);

$cmd = Genome::Model::Tools::Analysis::Coverage::CoverageHist->create(
                    somatic_validation_model_id => $somval_model_id,
                    output_pdf => $output_file);

ok($cmd, 'command created');

$rv = $cmd->execute;
is($rv, 1, 'Testing for successful execution.  Expecting 1.  Got: '.$rv);
