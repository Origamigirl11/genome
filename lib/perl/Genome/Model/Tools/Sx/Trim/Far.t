#!/usr/bin/env genome-perl

BEGIN {
    $ENV{UR_DBI_NO_COMMIT} = 1;
    $ENV{UR_USE_DUMMY_AUTOGENERATED_IDS} = 1;
    $ENV{UR_COMMAND_DUMP_STATUS_MESSAGES} = 1;
}

use strict;
use warnings;

use above "Genome";

use File::Temp;
use Test::More;

use_ok('Genome::Model::Tools::Sx::Trim::Far') or die;

my $datadir = Genome::Config::get('test_inputs').'/Genome-Model-Tools-Sx/TrimFar';
my $input1 = "$datadir/input_1.fastq";
ok(-s $input1, 'fastq input 1') or die;
my $input2 = "$datadir/input_2.fastq";
ok(-s $input2, 'fastq input 2') or die;

# Single adapter removal w/ v2.0
my $temp_dir = Genome::Sys->create_temp_directory;
my $cmd = Genome::Model::Tools::Sx::Trim::Far->create(
    input => [ $input1, $input2 ],
    output => [ "$temp_dir/output_1.fastq:name=fwd", "$temp_dir/output_2.fastq:name=rev" ],
    adapter => 'gtttcccagtcacgata',
    trim_end => 'any',
    cut_off => 2,
    min_overlap => 16,
    max_uncalled => 100,
    nr_threads => 4,
    version => '2.0',
    write_lengthdist => 'no',
);
ok($cmd, "create far 2.0 to remove single adapter");
ok($cmd->execute, "execute");
is_deeply($cmd->_cmds, ['/gsc/pkg/bio/flexibleadapter/flexibleadapter-2.0/build/far --adapters '.$cmd->_tmpdir.'/adapters.fasta --adaptive-overlap no --cut-off 2 --max-uncalled 100 --min-overlap 16 --min-readlength 18 --nr-threads 4 --trim-end any --write-lengthdist no --source '.$datadir.'/input_1.fastq --source2 '.$datadir.'/input_2.fastq --format fastq-sanger --target '.$cmd->_tmpdir.'/output.fastq'], 'far command');

my @output = glob("$temp_dir/*fastq");
is(@output, 2, "got 2 fastq files");
my @expected_output_md5 = (qw/ 2985af02886e81307831c9ee53a2f33e 1b54005b165a44264d5bb71f2b10b904 /);
for my $cnt (1..2) {
    is(Genome::Sys->md5sum($output[$cnt-1]), $expected_output_md5[$cnt-1], "single adapter removed fastq $cnt matches");
}

# Adapter w/ reverse complment removal single end w/ v2.0 w/ fasta so far input will need to be written
$temp_dir = Genome::Sys->create_temp_directory;
my $cmd2 = Genome::Model::Tools::Sx::Trim::Far->create(
    input => [ $datadir.'/input_1.fasta:qual_file='.$datadir.'/input_1.qual' ],
    output => [ "$temp_dir/output_1.fastq", ],
    adapter => 'gtttcccagtcacgata',
    remove_revcomp => 1, 
    trim_end => 'any',
    cut_off => 2,
    min_overlap => 16,
    max_uncalled => 100,
    nr_threads => 4,
    version => '2.0',
    write_lengthdist => 'no',
);
ok($cmd2, "create far 2.0 to remove w/ rev comp");
ok($cmd2->execute, "execute");
is_deeply($cmd2->_cmds, ['/gsc/pkg/bio/flexibleadapter/flexibleadapter-2.0/build/far --adapters '.$cmd2->_tmpdir.'/adapters.fasta --adaptive-overlap no --cut-off 2 --max-uncalled 100 --min-overlap 16 --min-readlength 18 --nr-threads 4 --trim-end any --write-lengthdist no --source '.$cmd2->_tmpdir.'/input_1.fastq --format fastq-sanger --target '.$cmd2->_tmpdir.'/output.fastq'], 'far command');
@output = glob("$temp_dir/*fastq");
is(@output, 1, "got 1 fastq file");
is(Genome::Sys->md5sum($output[0]), '8a7593bad737c1d4c266160ceec17687', "single adapter revcomp removed sigle end fastq matches");

# Adapter w/ reverse complment removal w/ v2.0 write to collated fastq
$temp_dir = Genome::Sys->create_temp_directory;
my $cmd3 = Genome::Model::Tools::Sx::Trim::Far->create(
    input => [ $input1, $input2 ],
    output => [ "$temp_dir/output.fastq", ],
    adapter => 'gtttcccagtcacgata',
    remove_revcomp => 1, 
    trim_end => 'any',
    cut_off => 2,
    min_overlap => 16,
    max_uncalled => 100,
    nr_threads => 4,
    version => '2.17',
    write_lengthdist => 'no',
);
ok($cmd3, "create far w/ v2.17 to remove rev comp");
ok($cmd3->execute, "execute");
is_deeply($cmd3->_cmds, ['/usr/bin/far2.17.0 --adapters '.$cmd3->_tmpdir.'/adapters.fasta --adaptive-overlap no --cut-off 2 --max-uncalled 100 --min-overlap 16 --min-readlength 18 --nr-threads 4 --trim-end any --write-lengthdist no --source '.$datadir.'/input_1.fastq --source2 '.$datadir.'/input_2.fastq --format fastq-sanger --target '.$cmd3->_tmpdir.'/output.fastq'], 'far command');
@output = glob("$temp_dir/*fastq");
is(@output, 1, "got 1 fastq file");
is(Genome::Sys->md5sum($output[0]), 'd2fe25c6ab7bb486907fc225b42459eb', "single adapter removed fastq matches");

#print $cmd3->_tmpdir."\n$temp_dir\n"; <STDIN>;
done_testing();
