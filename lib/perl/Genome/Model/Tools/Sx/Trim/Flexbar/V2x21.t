#!/usr/bin/env genome-perl

BEGIN {
    $ENV{UR_DBI_NO_COMMIT} = 1;
    $ENV{UR_USE_DUMMY_AUTOGENERATED_IDS} = 1;
    $ENV{UR_COMMAND_DUMP_STATUS_MESSAGES} = 1;
}

use strict;
use warnings;

use above "Genome";

use File::Temp;
use Test::More;

use_ok('Genome::Model::Tools::Sx::Trim::Flexbar::V2x21') or die;

my $datadir = Genome::Config::get('test_inputs').'/Genome-Model-Tools-Sx/TrimFlexbar';
my $input1 = "$datadir/input_1.fastq";
ok(-s $input1, 'fastq input 1') or die;
my $input2 = "$datadir/input_2.fastq";
ok(-s $input2, 'fastq input 2') or die;

my $temp_dir = Genome::Sys->create_temp_directory;
my $cmd = Genome::Model::Tools::Sx::Trim::Flexbar::V2x21->create(
    input => [ $input1, $input2 ],
    output => [ "$temp_dir/output.fastq", ],
    adapters => $datadir.'/adapters.fasta',
    adapter_gap_cost => -20,
    adapter_match => 3,
    adapter_min_overlap => 16,
    adapter_mismatch => -3,
    adapter_trim_end => 'ANY',
    max_uncalled => 100,
    no_length_dist => 1,
    threads => 4,
);
ok($cmd, "create flexbar to remove single adapter");
ok(eval{$cmd->execute}, "execute");
print "$@\n" if $@;
is_deeply($cmd->_cmds, ['/usr/bin/flexbar229 --adapter-gap-cost -20 --adapter-match 3 --adapter-min-overlap 16 --adapter-mismatch -3 --adapter-trim-end ANY --adapters '.$datadir.'/adapters.fasta --max-uncalled 100 --no-length-dist --threads 4 --source '.$datadir.'/input_1.fastq --source2 '.$datadir.'/input_2.fastq --format fastq-sanger --target '.$cmd->_tmpdir.'/output.fastq'], 'flexbar command');

my @output = glob("$temp_dir/*fastq");
is(@output, 1, "got 1 fastq files");
is(Genome::Sys->md5sum($output[0]), '0bc803457a4343eaa555b99916d226c3', "Output fastq matches");

#print "gvimdiff $output[0] $datadir/revcomp_adapter_removed.far2.17.fastq\n"; <STDIN>;
done_testing();
