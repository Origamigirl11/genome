#!/usr/bin/env genome-perl

BEGIN {
    $ENV{UR_DBI_NO_COMMIT} = 1;
    $ENV{UR_USE_DUMMY_AUTOGENERATED_IDS} = 1;
    $ENV{UR_COMMAND_DUMP_STATUS_MESSAGES} = 1;
}

use strict;
use warnings;

use above "Genome";

use File::Temp;
use Test::More;

use_ok('Genome::Model::Tools::Sx::Trim::Flexbar::V2x4') or die;

my $datadir = Genome::Config::get('test_inputs').'/Genome-Model-Tools-Sx/TrimFlexbar';
my $input1 = "$datadir/input_1.fastq";
ok(-s $input1, 'fastq input 1') or die;
my $input2 = "$datadir/input_2.fastq";
ok(-s $input2, 'fastq input 2') or die;

my $temp_dir = Genome::Sys->create_temp_directory;
my $flexbar_params = "--adapter-min-overlap 16 --adapter-threshold 3 --adapter-trim-end ANY --adapters $datadir/adapters.fasta --max-uncalled 100 --threads 4";
my $cmd = Genome::Model::Tools::Sx::Trim::Flexbar::V2x4->create(
    input => [ $input1, $input2 ],
    output => [ "$temp_dir/output.fastq", ],
    adapters => $datadir.'/adapters.fasta',
    adapter_threshold => 3,
    adapter_min_overlap => 16,
    adapter_trim_end => 'ANY',
    max_uncalled => 100,
    threads => 4,
);
ok($cmd, "create flexbar to remove single adapter");
ok(eval{$cmd->execute}, "execute");
print "$@\n" if $@;
is_deeply($cmd->_cmds, ['/usr/bin/flexbar2.4 '.$flexbar_params.' --reads '.$datadir.'/input_1.fastq --reads2 '.$datadir.'/input_2.fastq --format sanger --target '.$cmd->_tmpdir.'/output.fastq'], 'flexbar command');

my @output = glob("$temp_dir/*fastq");
is(@output, 1, "got 1 fastq files");
is(Genome::Sys->md5sum($output[0]), 'ed0aa6b88468d182bec2d65789b0c51c', "Output fastq matches");

#print "gvimdiff $output[0] $datadir/revcomp_adapter_removed.far2.17.fastq\n"; <STDIN>;
done_testing();
