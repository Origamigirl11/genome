#!/usr/bin/env genome-perl

use strict;
use warnings;

BEGIN {
    $ENV{UR_DBI_NO_COMMIT} = 1;
    $ENV{UR_USE_DUMMY_AUTOGENERATED_IDS} = 1;
}

use File::Path;
use File::Temp;
use Test::More;
use File::Compare;
use above 'Genome';

my $archos = `uname -a`;
if ($archos !~ /64/) {
    plan skip_all => "Must run from 64-bit machine";
} else {
    plan skip_all => "This is still under construction"; #tests => 4;
}

use_ok('Genome::Model::Tools::CopyNumber::BamToCn');

my $test_data =  Genome::Config::get('test_inputs') . "/Genome-Model-Tools-CopyNumber-BamToCn";

my $tmpbase = File::Temp::tempdir('BamToCnXXXXX', CLEANUP => 1, TMPDIR => 1);
my $output_file = "$tmpbase/bam-to-cn.bam2cn";
my $refbuild_id = 101947881;
my $bam = $test_data."/tumor.bam";
my $expected_output = $test_data."/expected_v1/chr22.luc1t.bam.bam2cn";

my $bam_to_cn = Genome::Model::Tools::CopyNumber::BamToCn->create(
                    aligned_reads_input => $bam,
                    output_file => $output_file,
                    window_size => 15000,
                    chromosome_number => "22", );


ok($bam_to_cn, 'gmt copy-number bam-to-cn command created');

my $rv = $bam_to_cn->execute;

is($rv, 1, 'Testing for successful execution.  Expecting 1.  Got: '.$rv);

is(compare($output_file, $expected_output), 0, 'Output was identical to expected output.');
