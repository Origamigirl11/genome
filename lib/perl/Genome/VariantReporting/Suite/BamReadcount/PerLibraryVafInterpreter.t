#!/usr/bin/env genome-perl

BEGIN { 
    $ENV{UR_DBI_NO_COMMIT} = 1;
    $ENV{UR_USE_DUMMY_AUTOGENERATED_IDS} = 1;
}

use strict;
use warnings;

use above "Genome";
use Test::Deep qw(cmp_bag);
use Test::More;
use Test::Exception;
use Genome::VariantReporting::Suite::BamReadcount::TestHelper qw(
    create_default_entry
    create_deletion_entry
    create_long_deletion_entry
    create_trio_entry
    create_no_readcount_entry
);

my $pkg = 'Genome::VariantReporting::Suite::BamReadcount::PerLibraryVafInterpreter';
use_ok($pkg);
my $factory = Genome::VariantReporting::Framework::Factory->create();
isa_ok($factory->get_class('interpreters', $pkg->name), $pkg);

my $library_names = [qw(Solexa-135853 Solexa-135852)];

subtest "one alt allele - multiple samples" => sub {
    my $interpreter = $pkg->create(
        sample_names => ["S1", "S2", "S3"],
        library_names => $library_names
    );
    lives_ok(sub {$interpreter->validate}, "Interpreter validates");

    my %expected = (
        G => {
            'Solexa-135852_var_count' => '155',
            'Solexa-135853_var_count' => '186',
            'Solexa-135852_ref_count' => '2',
            'Solexa-135853_ref_count' => '1',
            'Solexa-135852_vaf' => '87.0786516853933',
            'Solexa-135853_vaf' => '99.4652406417112',
        }
    );

    my $entry = create_default_entry;
    my %result = $interpreter->interpret_entry($entry, ['G']);
    is(keys %result, keys %expected, "First level keys as expected");
    is_deeply(\%result, \%expected, "Values are as expected");
    cmp_bag([$interpreter->available_fields], [keys %{$expected{G}}], 'Available fields as expected');
};

subtest "one alt allele - multiple samples - with library labels" => sub {
    my $interpreter = $pkg->create(
        sample_names => [
            'S1',
            'S2',
            'S3',
        ],
        library_names => [
            'S1-lg3-lib1',
            'S2-lg4-lib1',
            'S2-lg2-lib1',
            'S1-lg5-lib1',
            'S2-lg5-lib1',
            'S3-lg3-lib1',
            'S3-lg5-lib1',
            'S3-lg4-lib1',
        ],
        library_name_labels => {
            'S3-lg3-lib1'  => 'Followup-Library2(S3-lg3-lib1)',
            'S3-lg4-lib1'  => 'Followup-Library3(S3-lg4-lib1)',
            'S3-lg5-lib1'  => 'Followup-Library4(S3-lg5-lib1)',
            'S1-lg3-lib1'  => 'Discovery-Library2(S1-lg3-lib1)',
            'S1-lg5-lib1'  => 'Discovery-Library4(S1-lg5-lib1)',
            'S2-lg2-lib1'  => 'Normal-Library2(S2-lg2-lib1)',
            'S2-lg4-lib1'  => 'Normal-Library3(S2-lg4-lib1)',
            'S2-lg5-lib1'  => 'Normal-Library4(S2-lg5-lib1)',
        }
    );
    lives_ok(sub {$interpreter->validate}, "Interpreter validates");

    my %expected = (
        T => {
            'Discovery-Library2(S1-lg3-lib1)_ref_count' => 267,
            'Discovery-Library2(S1-lg3-lib1)_vaf' => 1.11111111111111,
            'Discovery-Library2(S1-lg3-lib1)_var_count' => 3,
            'Discovery-Library4(S1-lg5-lib1)_ref_count' => 184,
            'Discovery-Library4(S1-lg5-lib1)_vaf' => 0.537634408602151,
            'Discovery-Library4(S1-lg5-lib1)_var_count' => 1,
            'Followup-Library2(S3-lg3-lib1)_ref_count' => 238,
            'Followup-Library2(S3-lg3-lib1)_vaf' => 0,
            'Followup-Library2(S3-lg3-lib1)_var_count' => 0,
            'Followup-Library3(S3-lg4-lib1)_ref_count' => 320,
            'Followup-Library3(S3-lg4-lib1)_vaf' => 0,
            'Followup-Library3(S3-lg4-lib1)_var_count' => 0,
            'Followup-Library4(S3-lg5-lib1)_ref_count' => 189,
            'Followup-Library4(S3-lg5-lib1)_vaf' => 0,
            'Followup-Library4(S3-lg5-lib1)_var_count' => 0,
            'Normal-Library2(S2-lg2-lib1)_ref_count' => 221,
            'Normal-Library2(S2-lg2-lib1)_vaf' => 0,
            'Normal-Library2(S2-lg2-lib1)_var_count' => 0,
            'Normal-Library3(S2-lg4-lib1)_ref_count' => 260,
            'Normal-Library3(S2-lg4-lib1)_vaf' => 0,
            'Normal-Library3(S2-lg4-lib1)_var_count' => 0,
            'Normal-Library4(S2-lg5-lib1)_ref_count' => 208,
            'Normal-Library4(S2-lg5-lib1)_vaf' => 0.478468899521531,
            'Normal-Library4(S2-lg5-lib1)_var_count' => 1,
        }
    );

    my $entry = create_trio_entry;
    my %result = $interpreter->interpret_entry($entry, ['T']);
    is(keys %result, keys %expected, "First level keys as expected");
    is_deeply(\%result, \%expected, "Values are as expected");
    cmp_bag([$interpreter->available_fields], [keys %{$expected{T}}], 'Available fields as expected');
};

subtest "one alt allele" => sub {
    my $interpreter = $pkg->create(
        sample_names => ["S1"],
        library_names => $library_names
    );
    lives_ok(sub {$interpreter->validate}, "Interpreter validates");

    my %expected = (
        G => {
            'Solexa-135852_var_count' => '155',
            'Solexa-135853_var_count' => '186',
            'Solexa-135852_ref_count' => '2',
            'Solexa-135853_ref_count' => '1',
            'Solexa-135852_vaf' => '87.0786516853933',
            'Solexa-135853_vaf' => '99.4652406417112',
        }
    );

    my $entry = create_default_entry();
    my %result = $interpreter->interpret_entry($entry, ['G']);
    is_deeply(\%result, \%expected, "Values are as expected");
};

subtest "insertion" => sub {
    my $interpreter = $pkg->create(
        sample_names => ["S4"],
        library_names => $library_names
    );
    lives_ok(sub {$interpreter->validate}, "Interpreter validates");

    my %expected = (
        AA => {
            'Solexa-135852_var_count' => '20',
            'Solexa-135853_var_count' => '0',
            'Solexa-135852_ref_count' => '2',
            'Solexa-135853_ref_count' => '1',
            'Solexa-135852_vaf' => '11.2359550561798',
            'Solexa-135853_vaf' => '0',
        }
    );

    my $entry = create_default_entry();
    my %result = $interpreter->interpret_entry($entry, ['AA']);
    is_deeply(\%result, \%expected, "Values are as expected");
};

subtest "deletion" => sub {
    my $interpreter = $pkg->create(
        sample_names => ["S1"],
        library_names => $library_names
    );
    lives_ok(sub {$interpreter->validate}, "Interpreter validates");

    my %expected = (
        A => {
            'Solexa-135852_var_count' => '20',
            'Solexa-135853_var_count' => '0',
            'Solexa-135852_ref_count' => '3',
            'Solexa-135853_ref_count' => '2',
            'Solexa-135852_vaf' => '11.0497237569061',
            'Solexa-135853_vaf' => '0',
        }
    );

    my $entry = create_deletion_entry();
    my %result = $interpreter->interpret_entry($entry, ['A']);
    is_deeply(\%result, \%expected, "Values are as expected");
};

subtest "long indel" => sub {
    my $interpreter = $pkg->create(
        sample_names => ["S3"],
        library_names => [qw(S3-lg3-lib1 S3-lg5-lib1)]
    );
    lives_ok(sub {$interpreter->validate}, "Interpreter validates");

    my %expected = (
        'GTATA' => {
            'S3-lg3-lib1_ref_count' => 29,
            'S3-lg3-lib1_vaf' => 6.25,
            'S3-lg3-lib1_var_count' => 2,
            'S3-lg5-lib1_ref_count' => 18,
            'S3-lg5-lib1_vaf' => 9.52380952380952,
            'S3-lg5-lib1_var_count' => 2,
        }
    );

    my $entry = create_long_deletion_entry();
    my %result = $interpreter->interpret_entry($entry, ['GTATA']);
    is_deeply(\%result, \%expected, "Values are as expected");
};

subtest 'additional libraries' => sub {
    my $interpreter = $pkg->create(
        sample_names => ["S1"],
        library_names => [@$library_names, 'additional_library'],
    );
    lives_ok(sub {$interpreter->validate}, "Interpreter validates");

    my %expected = (
        G => {
            'Solexa-135852_var_count' => '155',
            'Solexa-135853_var_count' => '186',
            'Solexa-135852_ref_count' => '2',
            'Solexa-135853_ref_count' => '1',
            'Solexa-135852_vaf' => '87.0786516853933',
            'Solexa-135853_vaf' => '99.4652406417112',
            'additional_library_var_count' => '.',
            'additional_library_ref_count' => '.',
            'additional_library_vaf' => '.',
        }
    );

    my $entry = create_default_entry();
    my %result = $interpreter->interpret_entry($entry, ['G']);
    is_deeply(\%result, \%expected, "Values are as expected");
};

subtest 'no readcount entry' => sub {
    my $interpreter = $pkg->create(
        sample_names => ["S1"],
        library_names => $library_names,
    );
    lives_ok(sub {$interpreter->validate}, "Interpreter validates");

    my %expected = (
        G => {
            'Solexa-135852_var_count' => '.',
            'Solexa-135853_var_count' => '.',
            'Solexa-135852_ref_count' => '.',
            'Solexa-135853_ref_count' => '.',
            'Solexa-135852_vaf' => '.',
            'Solexa-135853_vaf' => '.',
        }
    );

    my $entry = create_no_readcount_entry();
    my %result = $interpreter->interpret_entry($entry, ['G']);
    is_deeply(\%result, \%expected, "Values are as expected");
};

done_testing;
